name: Test service routes (development)

# Todo: May want to tweak what branches this runs on
on:
  push:
    branches: ["*"]
  pull_request:
    branches: [ "*" ]

env:
  BRANCH_NAME: ${{ github.event.pull_request.base.ref || github.ref_name }}


jobs:
  build:
    env:
      HED_SERVER_URL: "http://127.0.0.1:33004/hed_dev"
    strategy:
      matrix:
        platform: [ubuntu-latest]
        python-version: ["3.10"]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v6

      - name: Make the script files executable
        run: chmod +x deploy/deploy.sh

      - name: Run deploy script (develop)
        run: | 
          cd deploy
          bash ./deploy.sh "$BRANCH_NAME" dev
          echo "\nVerifying container is running..."
          if ! docker ps | grep -q hedtools_dev; then
            echo "ERROR: Container hedtools_dev is not running!"
            echo "\nContainer status:"
            docker ps -a | grep hedtools_dev || echo "Container not found"
            echo "\nContainer logs:"
            docker logs hedtools_dev 2>&1 || echo "Could not get logs"
            exit 1
          fi
          echo "Container hedtools_dev is running successfully"

      - name: Show deploy status
        if: always()
        run: |
          echo "Checking Docker containers..."
          docker ps -a
          echo "Checking Docker images..."
          docker images

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          sleep 5
          echo "Checking if container is running..."
          docker ps | grep hedtools_dev || (echo "Container not running!" && docker logs hedtools_dev && exit 1)
          echo "Testing server health with retries..."
          for i in {1..30}; do
            if curl --silent --fail --max-time 5 ${{ env.HED_SERVER_URL }}; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i/30 failed, waiting 5 seconds..."
            sleep 5
          done
          echo "Server did not become ready in time"
          docker logs hedtools_dev
          exit 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade git+https://github.com/hed-standard/hed-python.git
          pip install -e .

      - name: Run service tests
        env:
          HED_SERVER_URL_KEY: ${{ env.HED_SERVER_URL }}
        run: python -m unittest discover services_tests

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "Displaying Docker logs..."
          docker logs hedtools_dev
